---
title: "Using Bill Benter's Methods in German Horse Racing"
output: github_document
---

```{r, message=FALSE, warning=FALSE}
library (data.table)
library(survival)
library(tidyverse)
library(zoo)
```


# 1 Horse Racing in Germany

## 1.1 Betting Market

Germany features two primary types of horse racing: Harness racing and flat racing. Steeplechasing and hurdling have largely faded into history. This notebook will concentrate on flat racing. 

Betting plays a crucial role in German horse racing, as a portion of the prize money is funded by the parimutuel betting operator's profits. Betting in Germany occurs through two primary channels: bookmakers (fixed odds) and the totalizator (parimutuel). For this analysis, the focus lies exclusively on parimutuel odds.


## 1.2 Takeout

In parimutuel betting, the track retains a commission known as takeout. In Germany, the takeout for win and place markets is 15%. Our analysis will concentrate solely on the win market.


# 2 Bill Benter's Approach

Inspired by Bolton and Chapman's (1986) paper, Bill Benter employed a conditional logistic regression model to predict horse racing outcomes in Hong Kong. His innovative approach incorporated the public's estimate, as reflected in betting odds, into his model. Following a similar path, we'll attempt to identify market inefficiencies within German horse racing. 


# 3 Data

The data used in this analysis has been acquired by web scraping. German horse racing results since 2002 up until 2024 have been gathered. But only the results since 2019 will be used in training and testing the model because before 2019 the takeout rate was much higher than 15%. Data before 2019 has however been used to construct the necessary features. Similar features to those mentioned by Bolton and Chapman (1986) have been engineered.

```{r}
# Import data
races <- readRDS("../data/processed/engineered_features.Rds")
```


## 3.1 Feature Descriptions

### Horse-related features

* **`hosr730`**: Horse's strike rate in the last 2 years
* **`hosr`**: Horse's career strike rate
* **`homean4sprat`**: Horse's mean speed rating in the last 4 races
* **`homeanearn365`**: Horse's mean earnings in the last 365 days
* **`holastsprat`**: Horse's last speed rating
* **`hofirstrace`**: Indicator if it's the horse's first race
* **`hodays`**: Number of days since the horse's last race
* **`hostall`**: Horse's stall number
* **`hono`**: Horse's number in the race card
* **`blinkers1sttime`**: Indicator if the horse is wearing blinkers for the first time
* **`weight`**: Weight carried by the horse


### Jockey-related features

* **`josr365`**: Jockey's strike rate in the last 365 days
* **`jowins365`**: Number of wins for the jockey in the last 365 days


### Trainer-related features

* **`trsr`**: Trainer's strike rate


### Other features

* **`odds`**: Betting odds for the horse



```{r}
features <- c(
  "hosr730", "hosr", "homean4sprat", "homeanearn365", "holastsprat", 
  "hofirstrace", "hodays", "draweffect_median", "gag", "blinkers1sttime", "weight",
  "josr365", "jowins365", "gagindicator", 
  "trsr",
  "odds"
)
```



## 3.2 Filtering the Data

Some jump races are also part of the dataset. But only flat races run on turf will be used. Stakes races won't be analysed. The focus will lie instead on Handicap races and in particular "Ausgleich IV" races which are the lowest class of racing Germany. Those races are run very frequently with many observations per horse in a year. 


DEAD HEATS!!


```{r}
data <- races %>% 
  filter(
    race_class_old == "Ausgleich IV",
    date_time > "2019-01-01 01:00:00",
    race_type == "flat",
    surface == "Turf"
  ) %>% 
  select(
    all_of(
      c(
        features,
        "dg_raceid", "date_time", "win", "dg_horseid", "horse", "hostall"
      )
    )
  ) %>% 
  filter(
    !is.na(odds)
  ) %>% 
  mutate(
    hodays = ifelse(hofirstrace == 1, 0, hodays)
  )

# homean4sprat missing (different reasons) exclude those races
races_missing_data <- data %>% 
  filter(is.na(homean4sprat)) %>% 
  pull(dg_raceid)

data <- data %>% 
  filter(! dg_raceid %in% races_missing_data)

# find races where stall numbers are missing
races_missing_stall <- data %>%  
  filter(is.na(hostall)) %>% 
  pull(dg_raceid)
data <- data %>% 
  filter(!dg_raceid %in% races_missing_stall)

data <- data %>% 
  arrange(date_time) %>% 
  mutate(holastsprat = na.locf(holastsprat))
```



# Train Data

```{r}
train_data <- data %>% 
  filter(date_time < "2021-01-01 01:00:00")
```

Model

 + hosr + homean4sprat + homeanearn365 + holastsprat + josr365 + 
    jowins365 + weight + hostall + hono + hofirstrace

```{r}

model_formula <- as.formula(
  paste(
    "win",
    paste(paste(features, collapse = " + "), "strata(dg_raceid)", sep = " + "),
    sep = " ~ "
  )
)
print(model_formula)
```



```{r}
model <- clogit(
  model_formula,
  data = train_data, method = "exact"
)
summary(model)
```


```{r}
coeffs <- as.vector(summary(model)$coefficients[, 1])
coeffs
```



# Test Data

```{r}
test_data <- data %>% 
  filter(
    date_time > "2021-01-01 01:00:00" 
  ) %>% 
  data.table()
```

Predictions

```{r}
predictions <- test_data[, prediction := as.matrix(test_data[, ..features]) %*% coeffs]
predictions <- predictions %>% 
  group_by(dg_raceid) %>% 
  mutate(
    exp_prediction = exp(prediction),
    sum_exp_prediction = sum(exp_prediction),
    my_prob = exp_prediction / sum_exp_prediction,
    expected_value = my_prob * (odds - 1) - (1 - my_prob)
  ) %>% 
  filter(
    expected_value > 0,
    expected_value == max(expected_value)
  ) %>% 
  ungroup() %>% 
  mutate(
    earnings = ifelse(
      win == 1, odds - 1, -1
    )
  )

sum(predictions$earnings)
```

```{r}

```




